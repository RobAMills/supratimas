<?xml version="1.0" encoding="utf-8"?>
<ShowPlanXML xmlns="http://schemas.microsoft.com/sqlserver/2004/07/showplan" Version="1.2" Build="11.0.3412.0">
  <BatchSequence>
    <Batch>
      <Statements>
        <StmtSimple StatementText="CREATE PROCEDURE [upload].[TeuResult_Process]&#xD;&#xA;AS&#xD;&#xA;    SET NOCOUNT ON;&#xD;&#xA;   " StatementId="1" StatementCompId="3" StatementType="SET ON/OFF" RetrievedFromCache="true" />
        <StmtSimple StatementText=" SET XACT_ABORT ON;&#xD;&#xA;&#x9;&#xD;&#xA;" StatementId="2" StatementCompId="4" StatementType="SET ON/OFF" RetrievedFromCache="true" />
        <StmtSimple StatementText="&#x9;DECLARE @logId int&#xD;&#xA;    DECLARE @hasProcessingError int = 1&#xD;&#xA;   " StatementId="3" StatementCompId="5" StatementType="ASSIGN" RetrievedFromCache="true" />
        <StmtSimple StatementText=" DECLARE @errorMessage varchar(4096)&#xD;&#xA;    DECLARE @orphanedLogUploadTime datetime&#xD;&#xA;&#x9;DECLARE @stopwatchBeginTime datetime2 = SYSDATETIME()&#xD;&#xA;&#xD;&#xA;   " StatementId="4" StatementCompId="6" StatementType="ASSIGN" RetrievedFromCache="true" />
        <StmtCond StatementText=" IF @@TRANCOUNT &lt;&gt; 0&#xD;&#xA;   " StatementId="5" StatementCompId="7" StatementType="COND" RetrievedFromCache="true">
          <Condition />
          <Then>
            <Statements>
              <StmtSimple StatementText=" BEGIN&#xD;&#xA;        -- When an exception occurs, the catch clause below rolls back current transaction. The complexity of a caller transaction is undesired. &#xD;&#xA;        -- Also, a calling transaction will place unintended locks on tables for duration of processing, which can be substantial depending on load.&#xD;&#xA;&#x9;&#x9;SET @errorMessage = 'Procedure ' + OBJECT_NAME(@@PROCID) + ' cannot be called with a composing transaction.';&#xD;&#xA;       " StatementId="6" StatementCompId="8" StatementType="ASSIGN" RetrievedFromCache="true" />
              <StmtSimple StatementText=" RAISERROR (@errorMessage, 15, 1);&#xD;&#xA;       " StatementId="7" StatementCompId="9" StatementType="RAISERROR" RetrievedFromCache="true" />
              <StmtSimple StatementText=" RETURN @hasProcessingError;&#xD;&#xA;   " StatementId="8" StatementCompId="10" StatementType="RETURN" RetrievedFromCache="true" />
            </Statements>
          </Then>
        </StmtCond>
        <StmtSimple StatementText=" END;&#xD;&#xA;&#xD;&#xA;    BEGIN TRY&#xD;&#xA;&#xD;&#xA;&#x9;    /*&#xD;&#xA;&#x9;    ** Reset orphaned results. If processing of a previous run resulted in an error, the corresponding TEUs are not marked complete, and &#xD;&#xA;        ** point to the old log identifier. Such results will not be re-visited because we restrict processing to a new log identifier every &#xD;&#xA;        ** time. By resetting the log identifier of orphaned results, we are forcing them to be inspected. The unprocessed log row is left &#xD;&#xA;        ** untouched because it may contain error information.&#xD;&#xA;&#x9;    */&#xD;&#xA;       " StatementId="9" StatementCompId="12" StatementType="BEGIN TRY" RetrievedFromCache="true" />
        <StmtSimple StatementText=" SET @orphanedLogUploadTime = DATEADD(hour, -1, GETDATE()); -- Any results not marked as complete after 60 minutes are considered orphaned.&#xD;&#xA;&#x9;   " StatementId="10" StatementCompId="13" StatementType="ASSIGN" RetrievedFromCache="true" />
        <StmtSimple StatementText=" UPDATE R&#xD;&#xA;&#x9;&#x9;    SET TeuResultLogId = NULL&#xD;&#xA;&#x9;    FROM upload.TeuResult AS R&#xD;&#xA;        JOIN upload.TeuResultLog AS L ON R.TeuResultLogId = L.Id&#xD;&#xA;        WHERE &#xD;&#xA;            L.Processed = 0 &#xD;&#xA;            AND R.UploadedDate &lt; @orphanedLogUploadTime&#xD;&#xA;&#xD;&#xA;&#x9;    /*&#xD;&#xA;&#x9;    ** Create our log record&#xD;&#xA;&#x9;    */&#xD;&#xA;&#x9;   " StatementId="11" StatementCompId="14" StatementType="UPDATE" RetrievedFromCache="true" StatementSubTreeCost="5.59203" StatementEstRows="6176.12" StatementOptmLevel="FULL" QueryHash="0xCBCE6F3C2DFC2340" QueryPlanHash="0xA65AE5C545A65F93">
          <StatementSetOptions QUOTED_IDENTIFIER="false" ARITHABORT="true" CONCAT_NULL_YIELDS_NULL="true" ANSI_NULLS="true" ANSI_PADDING="true" ANSI_WARNINGS="true" NUMERIC_ROUNDABORT="false" />
          <QueryPlan NonParallelPlanReason="MaxDOPSetToOne" CachedPlanSize="64" CompileTime="27" CompileCPU="27" CompileMemory="784">
            <MemoryGrantInfo SerialRequiredMemory="512" SerialDesiredMemory="3216" />
            <OptimizerHardwareDependentProperties EstimatedAvailableMemoryGrant="193313" EstimatedPagesCached="773254" EstimatedAvailableDegreeOfParallelism="1" />
            <RelOp NodeId="1" PhysicalOp="Index Update" LogicalOp="Update" EstimateRows="12352.2" EstimateIO="0.627766" EstimateCPU="0.0123522" AvgRowSize="9" EstimatedTotalSubtreeCost="5.59203" Parallel="0" EstimateRebinds="0" EstimateRewinds="0" EstimatedExecutionMode="Row">
              <OutputList />
              <Update WithOrderedPrefetch="1" DMLRequestSort="0">
                <Object Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Index="[TeuResult_AgentLog]" Alias="[R]" IndexKind="NonClustered" />
                <SetPredicate>
                  <ScalarOperator ScalarString="[Id1016] = [OurLabReporting].[upload].[TeuResult].[Id] as [R].[Id],[TeuId1017] = [OurLabReporting].[upload].[TeuResult].[TeuId] as [R].[TeuId],[TeuResultLogId1018] = [OurLabReporting].[upload].[TeuResult].[TeuResultLogId] as [R].[TeuResultLogId]">
                    <ScalarExpressionList>
                      <ScalarOperator>
                        <MultipleAssign>
                          <Assign>
                            <ColumnReference Column="Id1016" />
                            <ScalarOperator>
                              <Identifier>
                                <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="Id" />
                              </Identifier>
                            </ScalarOperator>
                          </Assign>
                          <Assign>
                            <ColumnReference Column="TeuId1017" />
                            <ScalarOperator>
                              <Identifier>
                                <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="TeuId" />
                              </Identifier>
                            </ScalarOperator>
                          </Assign>
                          <Assign>
                            <ColumnReference Column="TeuResultLogId1018" />
                            <ScalarOperator>
                              <Identifier>
                                <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="TeuResultLogId" />
                              </Identifier>
                            </ScalarOperator>
                          </Assign>
                        </MultipleAssign>
                      </ScalarOperator>
                    </ScalarExpressionList>
                  </ScalarOperator>
                </SetPredicate>
                <ActionColumn>
                  <ColumnReference Column="Act1015" />
                </ActionColumn>
                <RelOp NodeId="3" PhysicalOp="Filter" LogicalOp="Filter" EstimateRows="12352.2" EstimateIO="0" EstimateCPU="0.00469385" AvgRowSize="47" EstimatedTotalSubtreeCost="4.95191" Parallel="0" EstimateRebinds="0" EstimateRewinds="0" EstimatedExecutionMode="Row">
                  <OutputList>
                    <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="Id" />
                    <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="TeuId" />
                    <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="TeuResultLogId" />
                    <ColumnReference Column="Act1015" />
                  </OutputList>
                  <Filter StartupExpression="0">
                    <RelOp NodeId="4" PhysicalOp="Split" LogicalOp="Split" EstimateRows="12352.2" EstimateIO="0" EstimateCPU="0.00926418" AvgRowSize="48" EstimatedTotalSubtreeCost="4.94722" Parallel="0" EstimateRebinds="0" EstimateRewinds="0" EstimatedExecutionMode="Row">
                      <OutputList>
                        <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="Id" />
                        <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="TeuId" />
                        <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="TeuResultLogId" />
                        <ColumnReference Column="Expr1013" />
                        <ColumnReference Column="Act1015" />
                      </OutputList>
                      <Split>
                        <DefinedValues>
                          <DefinedValue>
                            <ColumnReference Column="Act1015" />
                          </DefinedValue>
                        </DefinedValues>
                        <ActionColumn>
                          <ColumnReference Column="Act1015" />
                        </ActionColumn>
                        <RelOp NodeId="5" PhysicalOp="Clustered Index Update" LogicalOp="Update" EstimateRows="6176.12" EstimateIO="0.43319" EstimateCPU="0.00617612" AvgRowSize="48" EstimatedTotalSubtreeCost="4.93795" Parallel="0" EstimateRebinds="0" EstimateRewinds="0" EstimatedExecutionMode="Row">
                          <OutputList>
                            <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="Id" />
                            <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="TeuId" />
                            <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="TeuResultLogId" />
                            <ColumnReference Column="TeuResultLogId_OLD" />
                            <ColumnReference Column="Expr1013" />
                          </OutputList>
                          <Update DMLRequestSort="0">
                            <Object Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Index="[TeuResult_PK]" Alias="[R]" IndexKind="Clustered" />
                            <SetPredicate>
                              <ScalarOperator ScalarString="[OurLabReporting].[upload].[TeuResult].[TeuResultLogId] as [R].[TeuResultLogId] = [Expr1004]">
                                <ScalarExpressionList>
                                  <ScalarOperator>
                                    <MultipleAssign>
                                      <Assign>
                                        <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="TeuResultLogId" />
                                        <ScalarOperator>
                                          <Identifier>
                                            <ColumnReference Column="Expr1004" />
                                          </Identifier>
                                        </ScalarOperator>
                                      </Assign>
                                    </MultipleAssign>
                                  </ScalarOperator>
                                </ScalarExpressionList>
                              </ScalarOperator>
                            </SetPredicate>
                            <RelOp NodeId="6" PhysicalOp="Compute Scalar" LogicalOp="Compute Scalar" EstimateRows="6176.12" EstimateIO="0" EstimateCPU="0.000617612" AvgRowSize="28" EstimatedTotalSubtreeCost="4.49859" Parallel="0" EstimateRebinds="0" EstimateRewinds="0" EstimatedExecutionMode="Row">
                              <OutputList>
                                <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="Id" />
                                <ColumnReference Column="Expr1004" />
                                <ColumnReference Column="Expr1013" />
                              </OutputList>
                              <ComputeScalar>
                                <DefinedValues>
                                  <DefinedValue>
                                    <ColumnReference Column="Expr1013" />
                                    <ScalarOperator ScalarString="[Expr1013]">
                                      <Identifier>
                                        <ColumnReference Column="Expr1013" />
                                      </Identifier>
                                    </ScalarOperator>
                                  </DefinedValue>
                                </DefinedValues>
                                <RelOp NodeId="7" PhysicalOp="Compute Scalar" LogicalOp="Compute Scalar" EstimateRows="6176.12" EstimateIO="0" EstimateCPU="0.000617612" AvgRowSize="28" EstimatedTotalSubtreeCost="4.49859" Parallel="0" EstimateRebinds="0" EstimateRewinds="0" EstimatedExecutionMode="Row">
                                  <OutputList>
                                    <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="Id" />
                                    <ColumnReference Column="Expr1004" />
                                    <ColumnReference Column="Expr1013" />
                                  </OutputList>
                                  <ComputeScalar>
                                    <DefinedValues>
                                      <DefinedValue>
                                        <ColumnReference Column="Expr1013" />
                                        <ScalarOperator ScalarString="CASE WHEN [Expr1010] THEN (1) ELSE (0) END">
                                          <IF>
                                            <Condition>
                                              <ScalarOperator>
                                                <Identifier>
                                                  <ColumnReference Column="Expr1010" />
                                                </Identifier>
                                              </ScalarOperator>
                                            </Condition>
                                            <Then>
                                              <ScalarOperator>
                                                <Const ConstValue="(1)" />
                                              </ScalarOperator>
                                            </Then>
                                            <Else>
                                              <ScalarOperator>
                                                <Const ConstValue="(0)" />
                                              </ScalarOperator>
                                            </Else>
                                          </IF>
                                        </ScalarOperator>
                                      </DefinedValue>
                                    </DefinedValues>
                                    <RelOp NodeId="8" PhysicalOp="Compute Scalar" LogicalOp="Compute Scalar" EstimateRows="6176.12" EstimateIO="0" EstimateCPU="0.000617612" AvgRowSize="28" EstimatedTotalSubtreeCost="4.49797" Parallel="0" EstimateRebinds="0" EstimateRewinds="0" EstimatedExecutionMode="Row">
                                      <OutputList>
                                        <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="Id" />
                                        <ColumnReference Column="Expr1004" />
                                        <ColumnReference Column="Expr1010" />
                                      </OutputList>
                                      <ComputeScalar>
                                        <DefinedValues>
                                          <DefinedValue>
                                            <ColumnReference Column="Expr1004" />
                                            <ScalarOperator ScalarString="NULL">
                                              <Const ConstValue="NULL" />
                                            </ScalarOperator>
                                          </DefinedValue>
                                        </DefinedValues>
                                        <RelOp NodeId="9" PhysicalOp="Table Spool" LogicalOp="Eager Spool" EstimateRows="6176.12" EstimateIO="0.013125" EstimateCPU="0.0023236" AvgRowSize="24" EstimatedTotalSubtreeCost="4.49735" Parallel="0" EstimateRebinds="0" EstimateRewinds="0" EstimatedExecutionMode="Row">
                                          <OutputList>
                                            <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="Id" />
                                            <ColumnReference Column="Expr1010" />
                                          </OutputList>
                                          <Spool>
                                            <RelOp NodeId="10" PhysicalOp="Compute Scalar" LogicalOp="Compute Scalar" EstimateRows="6176.12" EstimateIO="0" EstimateCPU="0.000617612" AvgRowSize="24" EstimatedTotalSubtreeCost="4.4819" Parallel="0" EstimateRebinds="0" EstimateRewinds="0" EstimatedExecutionMode="Row">
                                              <OutputList>
                                                <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="Id" />
                                                <ColumnReference Column="Expr1010" />
                                              </OutputList>
                                              <ComputeScalar>
                                                <DefinedValues>
                                                  <DefinedValue>
                                                    <ColumnReference Column="Expr1010" />
                                                    <ScalarOperator ScalarString="CASE WHEN [OurLabReporting].[upload].[TeuResult].[TeuResultLogId] as [R].[TeuResultLogId] IS NULL THEN (1) ELSE (0) END">
                                                      <IF>
                                                        <Condition>
                                                          <ScalarOperator>
                                                            <Compare CompareOp="BINARY IS">
                                                              <ScalarOperator>
                                                                <Identifier>
                                                                  <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="TeuResultLogId" />
                                                                </Identifier>
                                                              </ScalarOperator>
                                                              <ScalarOperator>
                                                                <Const ConstValue="NULL" />
                                                              </ScalarOperator>
                                                            </Compare>
                                                          </ScalarOperator>
                                                        </Condition>
                                                        <Then>
                                                          <ScalarOperator>
                                                            <Const ConstValue="(1)" />
                                                          </ScalarOperator>
                                                        </Then>
                                                        <Else>
                                                          <ScalarOperator>
                                                            <Const ConstValue="(0)" />
                                                          </ScalarOperator>
                                                        </Else>
                                                      </IF>
                                                    </ScalarOperator>
                                                  </DefinedValue>
                                                </DefinedValues>
                                                <RelOp NodeId="11" PhysicalOp="Nested Loops" LogicalOp="Inner Join" EstimateRows="20587.1" EstimateIO="0" EstimateCPU="0.086054" AvgRowSize="35" EstimatedTotalSubtreeCost="4.4714" Parallel="0" EstimateRebinds="0" EstimateRewinds="0" EstimatedExecutionMode="Row">
                                                  <OutputList>
                                                    <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="Id" />
                                                    <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="TeuResultLogId" />
                                                  </OutputList>
                                                  <NestedLoops Optimized="1" WithUnorderedPrefetch="1">
                                                    <OuterReferences>
                                                      <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="Id" />
                                                      <ColumnReference Column="Expr1020" />
                                                    </OuterReferences>
                                                    <RelOp NodeId="14" PhysicalOp="Nested Loops" LogicalOp="Inner Join" EstimateRows="20587.1" EstimateIO="0" EstimateCPU="0.086054" AvgRowSize="27" EstimatedTotalSubtreeCost="0.682226" Parallel="0" EstimateRebinds="0" EstimateRewinds="0" EstimatedExecutionMode="Row">
                                                      <OutputList>
                                                        <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="Id" />
                                                        <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="TeuResultLogId" />
                                                      </OutputList>
                                                      <NestedLoops Optimized="0" WithUnorderedPrefetch="1">
                                                        <OuterReferences>
                                                          <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResultLog]" Alias="[L]" Column="Id" />
                                                          <ColumnReference Column="Expr1019" />
                                                        </OuterReferences>
                                                        <RelOp NodeId="16" PhysicalOp="Index Seek" LogicalOp="Index Seek" EstimateRows="142.708" EstimateIO="0.003125" EstimateCPU="0.000313979" AvgRowSize="11" EstimatedTotalSubtreeCost="0.00343898" TableCardinality="1.35982e+006" Parallel="0" EstimateRebinds="0" EstimateRewinds="0" EstimatedExecutionMode="Row">
                                                          <OutputList>
                                                            <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResultLog]" Alias="[L]" Column="Id" />
                                                          </OutputList>
                                                          <IndexScan Ordered="1" ScanDirection="FORWARD" ForcedIndex="0" ForceSeek="0" ForceScan="0" NoExpandHint="0" Storage="RowStore">
                                                            <DefinedValues>
                                                              <DefinedValue>
                                                                <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResultLog]" Alias="[L]" Column="Id" />
                                                              </DefinedValue>
                                                            </DefinedValues>
                                                            <Object Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResultLog]" Index="[TeuResultLog_Processed]" Alias="[L]" IndexKind="NonClustered" />
                                                            <SeekPredicates>
                                                              <SeekPredicateNew>
                                                                <SeekKeys>
                                                                  <Prefix ScanType="EQ">
                                                                    <RangeColumns>
                                                                      <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResultLog]" Alias="[L]" Column="Processed" />
                                                                    </RangeColumns>
                                                                    <RangeExpressions>
                                                                      <ScalarOperator ScalarString="(0)">
                                                                        <Const ConstValue="(0)" />
                                                                      </ScalarOperator>
                                                                    </RangeExpressions>
                                                                  </Prefix>
                                                                </SeekKeys>
                                                              </SeekPredicateNew>
                                                            </SeekPredicates>
                                                          </IndexScan>
                                                        </RelOp>
                                                        <RelOp NodeId="17" PhysicalOp="Index Seek" LogicalOp="Index Seek" EstimateRows="144.26" EstimateIO="0.00386574" EstimateCPU="0.000315686" AvgRowSize="27" EstimatedTotalSubtreeCost="0.592733" TableCardinality="4.1884e+007" Parallel="0" EstimateRebinds="141.708" EstimateRewinds="0" EstimatedExecutionMode="Row">
                                                          <OutputList>
                                                            <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="Id" />
                                                            <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="TeuResultLogId" />
                                                          </OutputList>
                                                          <IndexScan Ordered="1" ScanDirection="FORWARD" ForcedIndex="0" ForceSeek="0" ForceScan="0" NoExpandHint="0" Storage="RowStore">
                                                            <DefinedValues>
                                                              <DefinedValue>
                                                                <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="Id" />
                                                              </DefinedValue>
                                                              <DefinedValue>
                                                                <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="TeuResultLogId" />
                                                              </DefinedValue>
                                                            </DefinedValues>
                                                            <Object Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Index="[TeuResult_AgentLog]" Alias="[R]" IndexKind="NonClustered" />
                                                            <SeekPredicates>
                                                              <SeekPredicateNew>
                                                                <SeekKeys>
                                                                  <Prefix ScanType="EQ">
                                                                    <RangeColumns>
                                                                      <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="TeuResultLogId" />
                                                                    </RangeColumns>
                                                                    <RangeExpressions>
                                                                      <ScalarOperator ScalarString="[OurLabReporting].[upload].[TeuResultLog].[Id] as [L].[Id]">
                                                                        <Identifier>
                                                                          <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResultLog]" Alias="[L]" Column="Id" />
                                                                        </Identifier>
                                                                      </ScalarOperator>
                                                                    </RangeExpressions>
                                                                  </Prefix>
                                                                </SeekKeys>
                                                              </SeekPredicateNew>
                                                            </SeekPredicates>
                                                          </IndexScan>
                                                        </RelOp>
                                                      </NestedLoops>
                                                    </RelOp>
                                                    <RelOp NodeId="19" PhysicalOp="Clustered Index Seek" LogicalOp="Clustered Index Seek" EstimateRows="6176.12" EstimateIO="0.003125" EstimateCPU="0.0001581" AvgRowSize="15" EstimatedTotalSubtreeCost="3.70312" TableCardinality="4.1884e+007" Parallel="0" EstimateRebinds="20443.6" EstimateRewinds="142.482" EstimatedExecutionMode="Row">
                                                      <OutputList />
                                                      <IndexScan Lookup="1" Ordered="1" ScanDirection="FORWARD" ForcedIndex="0" ForceSeek="0" ForceScan="0" NoExpandHint="0" Storage="RowStore">
                                                        <DefinedValues />
                                                        <Object Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Index="[TeuResult_PK]" Alias="[R]" TableReferenceId="-1" IndexKind="Clustered" />
                                                        <SeekPredicates>
                                                          <SeekPredicateNew>
                                                            <SeekKeys>
                                                              <Prefix ScanType="EQ">
                                                                <RangeColumns>
                                                                  <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="Id" />
                                                                </RangeColumns>
                                                                <RangeExpressions>
                                                                  <ScalarOperator ScalarString="[OurLabReporting].[upload].[TeuResult].[Id] as [R].[Id]">
                                                                    <Identifier>
                                                                      <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="Id" />
                                                                    </Identifier>
                                                                  </ScalarOperator>
                                                                </RangeExpressions>
                                                              </Prefix>
                                                            </SeekKeys>
                                                          </SeekPredicateNew>
                                                        </SeekPredicates>
                                                        <Predicate>
                                                          <ScalarOperator ScalarString="[OurLabReporting].[upload].[TeuResult].[UploadedDate] as [R].[UploadedDate]&lt;[@orphanedLogUploadTime]">
                                                            <Compare CompareOp="LT">
                                                              <ScalarOperator>
                                                                <Identifier>
                                                                  <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="UploadedDate" />
                                                                </Identifier>
                                                              </ScalarOperator>
                                                              <ScalarOperator>
                                                                <Identifier>
                                                                  <ColumnReference Column="@orphanedLogUploadTime" />
                                                                </Identifier>
                                                              </ScalarOperator>
                                                            </Compare>
                                                          </ScalarOperator>
                                                        </Predicate>
                                                      </IndexScan>
                                                    </RelOp>
                                                  </NestedLoops>
                                                </RelOp>
                                              </ComputeScalar>
                                            </RelOp>
                                          </Spool>
                                        </RelOp>
                                      </ComputeScalar>
                                    </RelOp>
                                  </ComputeScalar>
                                </RelOp>
                              </ComputeScalar>
                            </RelOp>
                          </Update>
                        </RelOp>
                      </Split>
                    </RelOp>
                    <Predicate>
                      <ScalarOperator ScalarString="NOT [Expr1013]">
                        <Logical Operation="NOT">
                          <ScalarOperator>
                            <Identifier>
                              <ColumnReference Column="Expr1013" />
                            </Identifier>
                          </ScalarOperator>
                        </Logical>
                      </ScalarOperator>
                    </Predicate>
                  </Filter>
                </RelOp>
              </Update>
            </RelOp>
          </QueryPlan>
        </StmtSimple>
        <StmtSimple StatementText=" INSERT INTO upload.TeuResultLog(Processed)&#xD;&#xA;&#x9;    VALUES (0);&#xD;&#xA;&#xD;&#xA;&#x9;   " StatementId="12" StatementCompId="15" StatementType="INSERT" RetrievedFromCache="true" StatementSubTreeCost="0.0200034" StatementEstRows="1" StatementOptmLevel="TRIVIAL" QueryHash="0xD8ED5734F442EF86" QueryPlanHash="0x62A8DF2F126E1719">
          <StatementSetOptions QUOTED_IDENTIFIER="false" ARITHABORT="true" CONCAT_NULL_YIELDS_NULL="true" ANSI_NULLS="true" ANSI_PADDING="true" ANSI_WARNINGS="true" NUMERIC_ROUNDABORT="false" />
          <QueryPlan NonParallelPlanReason="MaxDOPSetToOne" CachedPlanSize="24" CompileTime="2" CompileCPU="2" CompileMemory="296">
            <MemoryGrantInfo SerialRequiredMemory="0" SerialDesiredMemory="0" />
            <OptimizerHardwareDependentProperties EstimatedAvailableMemoryGrant="193313" EstimatedPagesCached="773254" EstimatedAvailableDegreeOfParallelism="1" />
            <RelOp NodeId="0" PhysicalOp="Clustered Index Insert" LogicalOp="Insert" EstimateRows="1" EstimateIO="0.02" EstimateCPU="2e-006" AvgRowSize="9" EstimatedTotalSubtreeCost="0.0200034" Parallel="0" EstimateRebinds="0" EstimateRewinds="0" EstimatedExecutionMode="Row">
              <OutputList />
              <Update DMLRequestSort="0">
                <Object Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResultLog]" Index="[TeuResultLog_PK]" IndexKind="Clustered" />
                <Object Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResultLog]" Index="[TeuResultLog_Processed]" IndexKind="NonClustered" />
                <SetPredicate>
                  <ScalarOperator ScalarString="[OurLabReporting].[upload].[TeuResultLog].[Processed] = [Expr1004],[OurLabReporting].[upload].[TeuResultLog].[Id] = [Expr1003],[OurLabReporting].[upload].[TeuResultLog].[ProcessingStartDate] = [Expr1005],[OurLabReporting].[upload].[TeuResultLog].[HasError] = [Expr1006],[OurLabReporting].[upload].[TeuResultLog].[ErrorMessage] = NULL,[OurLabReporting].[upload].[TeuResultLog].[ProcessingDuration] = NULL">
                    <ScalarExpressionList>
                      <ScalarOperator>
                        <MultipleAssign>
                          <Assign>
                            <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResultLog]" Column="Processed" />
                            <ScalarOperator>
                              <Identifier>
                                <ColumnReference Column="Expr1004" />
                              </Identifier>
                            </ScalarOperator>
                          </Assign>
                          <Assign>
                            <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResultLog]" Column="Id" />
                            <ScalarOperator>
                              <Identifier>
                                <ColumnReference Column="Expr1003" />
                              </Identifier>
                            </ScalarOperator>
                          </Assign>
                          <Assign>
                            <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResultLog]" Column="ProcessingStartDate" />
                            <ScalarOperator>
                              <Identifier>
                                <ColumnReference Column="Expr1005" />
                              </Identifier>
                            </ScalarOperator>
                          </Assign>
                          <Assign>
                            <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResultLog]" Column="HasError" />
                            <ScalarOperator>
                              <Identifier>
                                <ColumnReference Column="Expr1006" />
                              </Identifier>
                            </ScalarOperator>
                          </Assign>
                          <Assign>
                            <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResultLog]" Column="ErrorMessage" />
                            <ScalarOperator>
                              <Const ConstValue="NULL" />
                            </ScalarOperator>
                          </Assign>
                          <Assign>
                            <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResultLog]" Column="ProcessingDuration" />
                            <ScalarOperator>
                              <Const ConstValue="NULL" />
                            </ScalarOperator>
                          </Assign>
                        </MultipleAssign>
                      </ScalarOperator>
                    </ScalarExpressionList>
                  </ScalarOperator>
                </SetPredicate>
                <RelOp NodeId="1" PhysicalOp="Compute Scalar" LogicalOp="Compute Scalar" EstimateRows="1" EstimateIO="0" EstimateCPU="1e-007" AvgRowSize="20" EstimatedTotalSubtreeCost="1.357e-006" Parallel="0" EstimateRebinds="0" EstimateRewinds="0" EstimatedExecutionMode="Row">
                  <OutputList>
                    <ColumnReference Column="Expr1003" />
                    <ColumnReference Column="Expr1004" />
                    <ColumnReference Column="Expr1005" />
                    <ColumnReference Column="Expr1006" />
                  </OutputList>
                  <ComputeScalar>
                    <DefinedValues>
                      <DefinedValue>
                        <ColumnReference Column="Expr1004" />
                        <ScalarOperator ScalarString="(0)">
                          <Const ConstValue="(0)" />
                        </ScalarOperator>
                      </DefinedValue>
                      <DefinedValue>
                        <ColumnReference Column="Expr1005" />
                        <ScalarOperator ScalarString="getdate()">
                          <Identifier>
                            <ColumnReference Column="ConstExpr1007">
                              <ScalarOperator>
                                <Intrinsic FunctionName="getdate" />
                              </ScalarOperator>
                            </ColumnReference>
                          </Identifier>
                        </ScalarOperator>
                      </DefinedValue>
                      <DefinedValue>
                        <ColumnReference Column="Expr1006" />
                        <ScalarOperator ScalarString="(0)">
                          <Const ConstValue="(0)" />
                        </ScalarOperator>
                      </DefinedValue>
                    </DefinedValues>
                    <RelOp NodeId="2" PhysicalOp="Compute Scalar" LogicalOp="Compute Scalar" EstimateRows="1" EstimateIO="0" EstimateCPU="1e-007" AvgRowSize="11" EstimatedTotalSubtreeCost="1.257e-006" Parallel="0" EstimateRebinds="0" EstimateRewinds="0" EstimatedExecutionMode="Row">
                      <OutputList>
                        <ColumnReference Column="Expr1003" />
                      </OutputList>
                      <ComputeScalar ComputeSequence="1">
                        <DefinedValues>
                          <DefinedValue>
                            <ColumnReference Column="Expr1003" />
                            <ScalarOperator ScalarString="getidentity((757577737),(6),NULL)">
                              <Intrinsic FunctionName="getidentity">
                                <ScalarOperator>
                                  <Const ConstValue="(757577737)" />
                                </ScalarOperator>
                                <ScalarOperator>
                                  <Const ConstValue="(6)" />
                                </ScalarOperator>
                                <ScalarOperator>
                                  <Const ConstValue="NULL" />
                                </ScalarOperator>
                              </Intrinsic>
                            </ScalarOperator>
                          </DefinedValue>
                        </DefinedValues>
                        <RelOp NodeId="3" PhysicalOp="Constant Scan" LogicalOp="Constant Scan" EstimateRows="1" EstimateIO="0" EstimateCPU="1.157e-006" AvgRowSize="9" EstimatedTotalSubtreeCost="1.157e-006" Parallel="0" EstimateRebinds="0" EstimateRewinds="0" EstimatedExecutionMode="Row">
                          <OutputList />
                          <ConstantScan />
                        </RelOp>
                      </ComputeScalar>
                    </RelOp>
                  </ComputeScalar>
                </RelOp>
              </Update>
            </RelOp>
          </QueryPlan>
        </StmtSimple>
        <StmtSimple StatementText=" SET @logId = SCOPE_IDENTITY();&#xD;&#xA;&#xD;&#xA;&#x9;    /*&#xD;&#xA;&#x9;    ** Claim the groups we will process&#xD;&#xA;&#x9;    ** We may upload a given Teu multiple times, only take one in each pass&#xD;&#xA;&#x9;    ** Otherwise our MERGE statements get mucked up.&#xD;&#xA;&#x9;    ** We could delete the duplicates but choose to process them all as that is quicker.&#xD;&#xA;&#x9;    */&#xD;&#xA;&#x9;  " StatementId="13" StatementCompId="16" StatementType="ASSIGN" RetrievedFromCache="true" />
        <StmtSimple StatementText="&#x9;UPDATE R&#xD;&#xA;&#x9;&#x9;    SET TeuResultLogId = @logId&#xD;&#xA;&#x9;    FROM upload.TeuResult AS R&#xD;&#xA;&#x9;    WHERE R.Id IN (&#xD;&#xA;&#x9;&#x9;&#x9;SELECT TOP 750 R.Id&#xD;&#xA; &#x9;&#x9;&#x9;FROM upload.TeuResult AS R&#xD;&#xA;&#x9;&#x9;&#x9;WHERE R.Id IN (&#xD;&#xA;&#x9;&#x9;&#x9;&#x9;SELECT TOP 1 innerR.Id&#xD;&#xA;&#x9;&#x9;&#x9;&#x9;FROM upload.TeuResult AS innerR&#xD;&#xA;&#x9;&#x9;&#x9;&#x9;WHERE innerR.TeuResultLogId IS NULL AND innerR.TeuId = R.TeuId &#xD;&#xA;&#x9;&#x9;&#x9;) AND R.TeuResultLogId IS NULL&#xD;&#xA;&#x9;&#x9;&#x9;ORDER BY R.UploadedDate ASC&#xD;&#xA;&#x9;    )&#xD;&#xA;&#xD;&#xA;&#x9;    /*&#xD;&#xA;&#x9;    ** Add any new paths and lookup the path Id's&#xD;&#xA;&#x9;    */&#xD;&#xA;&#x9;   " StatementId="14" StatementCompId="17" StatementType="UPDATE" RetrievedFromCache="true" StatementSubTreeCost="0.0610229" StatementEstRows="1" StatementOptmLevel="FULL" QueryHash="0x8C4F219DC0C206C0" QueryPlanHash="0x9602688B2A3F1F66" StatementOptmEarlyAbortReason="GoodEnoughPlanFound">
          <StatementSetOptions QUOTED_IDENTIFIER="false" ARITHABORT="true" CONCAT_NULL_YIELDS_NULL="true" ANSI_NULLS="true" ANSI_PADDING="true" ANSI_WARNINGS="true" NUMERIC_ROUNDABORT="false" />
          <QueryPlan NonParallelPlanReason="MaxDOPSetToOne" CachedPlanSize="64" CompileTime="15" CompileCPU="15" CompileMemory="808">
            <MemoryGrantInfo SerialRequiredMemory="1024" SerialDesiredMemory="1088" />
            <OptimizerHardwareDependentProperties EstimatedAvailableMemoryGrant="193313" EstimatedPagesCached="773254" EstimatedAvailableDegreeOfParallelism="1" />
            <RelOp NodeId="1" PhysicalOp="Assert" LogicalOp="Assert" EstimateRows="1" EstimateIO="0" EstimateCPU="7.8e-007" AvgRowSize="9" EstimatedTotalSubtreeCost="0.0610229" Parallel="0" EstimateRebinds="0" EstimateRewinds="0" EstimatedExecutionMode="Row">
              <OutputList />
              <Assert StartupExpression="0">
                <RelOp NodeId="2" PhysicalOp="Nested Loops" LogicalOp="Left Semi Join" EstimateRows="1" EstimateIO="0" EstimateCPU="4.18e-006" AvgRowSize="9" EstimatedTotalSubtreeCost="0.0610222" Parallel="0" EstimateRebinds="0" EstimateRewinds="0" EstimatedExecutionMode="Row">
                  <OutputList>
                    <ColumnReference Column="Expr1016" />
                    <ColumnReference Column="Pass1017" />
                  </OutputList>
                  <NestedLoops Optimized="0">
                    <DefinedValues>
                      <DefinedValue>
                        <ColumnReference Column="Expr1016" />
                      </DefinedValue>
                      <DefinedValue>
                        <ColumnReference Column="Pass1017" />
                      </DefinedValue>
                    </DefinedValues>
                    <PassThru>
                      <ScalarOperator ScalarString="[OurLabReporting].[upload].[TeuResult].[TeuResultLogId] as [R].[TeuResultLogId] IS NULL">
                        <Logical Operation="IS NULL">
                          <ScalarOperator>
                            <Identifier>
                              <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="TeuResultLogId" />
                            </Identifier>
                          </ScalarOperator>
                        </Logical>
                      </ScalarOperator>
                    </PassThru>
                    <OuterReferences>
                      <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="TeuResultLogId" />
                    </OuterReferences>
                    <ProbeColumn>
                      <ColumnReference Column="Expr1016" />
                    </ProbeColumn>
                    <RelOp NodeId="3" PhysicalOp="Clustered Index Update" LogicalOp="Update" EstimateRows="1" EstimateIO="0.02" EstimateCPU="2e-006" AvgRowSize="11" EstimatedTotalSubtreeCost="0.0577347" Parallel="0" EstimateRebinds="0" EstimateRewinds="0" EstimatedExecutionMode="Row">
                      <OutputList>
                        <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="TeuResultLogId" />
                      </OutputList>
                      <Update DMLRequestSort="0">
                        <Object Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Index="[TeuResult_PK]" Alias="[R]" IndexKind="Clustered" />
                        <Object Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Index="[TeuResult_AgentLog]" Alias="[R]" IndexKind="NonClustered" />
                        <SetPredicate>
                          <ScalarOperator ScalarString="[OurLabReporting].[upload].[TeuResult].[TeuResultLogId] as [R].[TeuResultLogId] = [@logId]">
                            <ScalarExpressionList>
                              <ScalarOperator>
                                <MultipleAssign>
                                  <Assign>
                                    <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="TeuResultLogId" />
                                    <ScalarOperator>
                                      <Identifier>
                                        <ColumnReference Column="@logId" />
                                      </Identifier>
                                    </ScalarOperator>
                                  </Assign>
                                </MultipleAssign>
                              </ScalarOperator>
                            </ScalarExpressionList>
                          </ScalarOperator>
                        </SetPredicate>
                        <RelOp NodeId="4" PhysicalOp="Compute Scalar" LogicalOp="Compute Scalar" EstimateRows="1" EstimateIO="0.013125" EstimateCPU="0.00010056" AvgRowSize="27" EstimatedTotalSubtreeCost="0.0377327" Parallel="0" EstimateRebinds="0" EstimateRewinds="0" EstimatedExecutionMode="Row">
                          <OutputList>
                            <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="Id" />
                            <ColumnReference Column="Expr1014" />
                          </OutputList>
                          <ComputeScalar>
                            <DefinedValues>
                              <DefinedValue>
                                <ColumnReference Column="Expr1014" />
                                <ScalarOperator ScalarString="[Expr1014]">
                                  <Identifier>
                                    <ColumnReference Column="Expr1014" />
                                  </Identifier>
                                </ScalarOperator>
                              </DefinedValue>
                            </DefinedValues>
                            <RelOp NodeId="5" PhysicalOp="Table Spool" LogicalOp="Eager Spool" EstimateRows="1" EstimateIO="0.013125" EstimateCPU="0.00010056" AvgRowSize="27" EstimatedTotalSubtreeCost="0.0377327" Parallel="0" EstimateRebinds="0" EstimateRewinds="0" EstimatedExecutionMode="Row">
                              <OutputList>
                                <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="Id" />
                                <ColumnReference Column="Expr1014" />
                              </OutputList>
                              <Spool>
                                <RelOp NodeId="6" PhysicalOp="Compute Scalar" LogicalOp="Compute Scalar" EstimateRows="1" EstimateIO="0" EstimateCPU="1e-007" AvgRowSize="27" EstimatedTotalSubtreeCost="0.0245071" Parallel="0" EstimateRebinds="0" EstimateRewinds="0" EstimatedExecutionMode="Row">
                                  <OutputList>
                                    <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="Id" />
                                    <ColumnReference Column="Expr1014" />
                                  </OutputList>
                                  <ComputeScalar>
                                    <DefinedValues>
                                      <DefinedValue>
                                        <ColumnReference Column="Expr1014" />
                                        <ScalarOperator ScalarString="CASE WHEN [Expr1011] THEN (0) ELSE (1) END">
                                          <IF>
                                            <Condition>
                                              <ScalarOperator>
                                                <Identifier>
                                                  <ColumnReference Column="Expr1011" />
                                                </Identifier>
                                              </ScalarOperator>
                                            </Condition>
                                            <Then>
                                              <ScalarOperator>
                                                <Const ConstValue="(0)" />
                                              </ScalarOperator>
                                            </Then>
                                            <Else>
                                              <ScalarOperator>
                                                <Const ConstValue="(1)" />
                                              </ScalarOperator>
                                            </Else>
                                          </IF>
                                        </ScalarOperator>
                                      </DefinedValue>
                                    </DefinedValues>
                                    <RelOp NodeId="7" PhysicalOp="Compute Scalar" LogicalOp="Compute Scalar" EstimateRows="1" EstimateIO="0" EstimateCPU="1e-007" AvgRowSize="24" EstimatedTotalSubtreeCost="0.024507" Parallel="0" EstimateRebinds="0" EstimateRewinds="0" EstimatedExecutionMode="Row">
                                      <OutputList>
                                        <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="Id" />
                                        <ColumnReference Column="Expr1011" />
                                      </OutputList>
                                      <ComputeScalar>
                                        <DefinedValues>
                                          <DefinedValue>
                                            <ColumnReference Column="Expr1011" />
                                            <ScalarOperator ScalarString="CASE WHEN [OurLabReporting].[upload].[TeuResult].[TeuResultLogId] as [R].[TeuResultLogId] = [@logId] THEN (1) ELSE (0) END">
                                              <IF>
                                                <Condition>
                                                  <ScalarOperator>
                                                    <Compare CompareOp="BINARY IS">
                                                      <ScalarOperator>
                                                        <Identifier>
                                                          <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="TeuResultLogId" />
                                                        </Identifier>
                                                      </ScalarOperator>
                                                      <ScalarOperator>
                                                        <Identifier>
                                                          <ColumnReference Column="@logId" />
                                                        </Identifier>
                                                      </ScalarOperator>
                                                    </Compare>
                                                  </ScalarOperator>
                                                </Condition>
                                                <Then>
                                                  <ScalarOperator>
                                                    <Const ConstValue="(1)" />
                                                  </ScalarOperator>
                                                </Then>
                                                <Else>
                                                  <ScalarOperator>
                                                    <Const ConstValue="(0)" />
                                                  </ScalarOperator>
                                                </Else>
                                              </IF>
                                            </ScalarOperator>
                                          </DefinedValue>
                                        </DefinedValues>
                                        <RelOp NodeId="9" PhysicalOp="Nested Loops" LogicalOp="Inner Join" EstimateRows="1" EstimateIO="0" EstimateCPU="4.18e-006" AvgRowSize="27" EstimatedTotalSubtreeCost="0.0245069" Parallel="0" EstimateRebinds="0" EstimateRewinds="0" EstimatedExecutionMode="Row">
                                          <OutputList>
                                            <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="Id" />
                                            <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="TeuResultLogId" />
                                          </OutputList>
                                          <NestedLoops Optimized="0">
                                            <OuterReferences>
                                              <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="Id" />
                                            </OuterReferences>
                                            <RelOp NodeId="10" PhysicalOp="Sort" LogicalOp="TopN Sort" EstimateRows="1" EstimateIO="0.0112613" EstimateCPU="0.000100031" AvgRowSize="31" EstimatedTotalSubtreeCost="0.0212195" Parallel="0" EstimateRebinds="0" EstimateRewinds="0" EstimatedExecutionMode="Row">
                                              <OutputList>
                                                <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="Id" />
                                                <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="UploadedDate" />
                                              </OutputList>
                                              <MemoryFractions Input="0.5" Output="1" />
                                              <TopSort Distinct="0" Rows="750">
                                                <OrderBy>
                                                  <OrderByColumn Ascending="1">
                                                    <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="UploadedDate" />
                                                  </OrderByColumn>
                                                </OrderBy>
                                                <RelOp NodeId="11" PhysicalOp="Nested Loops" LogicalOp="Left Semi Join" EstimateRows="1" EstimateIO="0" EstimateCPU="4.18e-006" AvgRowSize="31" EstimatedTotalSubtreeCost="0.00985824" Parallel="0" EstimateRebinds="0" EstimateRewinds="0" EstimatedExecutionMode="Row">
                                                  <OutputList>
                                                    <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="Id" />
                                                    <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="UploadedDate" />
                                                  </OutputList>
                                                  <NestedLoops Optimized="0">
                                                    <OuterReferences>
                                                      <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="Id" />
                                                      <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="TeuId" />
                                                    </OuterReferences>
                                                    <RelOp NodeId="12" PhysicalOp="Nested Loops" LogicalOp="Inner Join" EstimateRows="1" EstimateIO="0" EstimateCPU="4.18e-006" AvgRowSize="47" EstimatedTotalSubtreeCost="0.00657038" Parallel="0" EstimateRebinds="0" EstimateRewinds="0" EstimatedExecutionMode="Row">
                                                      <OutputList>
                                                        <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="Id" />
                                                        <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="TeuId" />
                                                        <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="UploadedDate" />
                                                      </OutputList>
                                                      <NestedLoops Optimized="1">
                                                        <OuterReferences>
                                                          <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="Id" />
                                                        </OuterReferences>
                                                        <RelOp NodeId="14" PhysicalOp="Index Seek" LogicalOp="Index Seek" EstimateRows="1" EstimateIO="0.003125" EstimateCPU="0.0001581" AvgRowSize="39" EstimatedTotalSubtreeCost="0.0032831" TableCardinality="4.1884e+007" Parallel="0" EstimateRebinds="0" EstimateRewinds="0" EstimatedExecutionMode="Row">
                                                          <OutputList>
                                                            <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="Id" />
                                                            <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="TeuId" />
                                                          </OutputList>
                                                          <IndexScan Ordered="1" ScanDirection="FORWARD" ForcedIndex="0" ForceSeek="0" ForceScan="0" NoExpandHint="0" Storage="RowStore">
                                                            <DefinedValues>
                                                              <DefinedValue>
                                                                <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="Id" />
                                                              </DefinedValue>
                                                              <DefinedValue>
                                                                <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="TeuId" />
                                                              </DefinedValue>
                                                            </DefinedValues>
                                                            <Object Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Index="[TeuResult_AgentLog]" Alias="[R]" TableReferenceId="2" IndexKind="NonClustered" />
                                                            <SeekPredicates>
                                                              <SeekPredicateNew>
                                                                <SeekKeys>
                                                                  <Prefix ScanType="EQ">
                                                                    <RangeColumns>
                                                                      <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="TeuResultLogId" />
                                                                    </RangeColumns>
                                                                    <RangeExpressions>
                                                                      <ScalarOperator ScalarString="NULL">
                                                                        <Const ConstValue="NULL" />
                                                                      </ScalarOperator>
                                                                    </RangeExpressions>
                                                                  </Prefix>
                                                                </SeekKeys>
                                                              </SeekPredicateNew>
                                                            </SeekPredicates>
                                                          </IndexScan>
                                                        </RelOp>
                                                        <RelOp NodeId="16" PhysicalOp="Clustered Index Seek" LogicalOp="Clustered Index Seek" EstimateRows="1" EstimateIO="0.003125" EstimateCPU="0.0001581" AvgRowSize="15" EstimatedTotalSubtreeCost="0.0032831" TableCardinality="4.1884e+007" Parallel="0" EstimateRebinds="0" EstimateRewinds="0" EstimatedExecutionMode="Row">
                                                          <OutputList>
                                                            <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="UploadedDate" />
                                                          </OutputList>
                                                          <IndexScan Lookup="1" Ordered="1" ScanDirection="FORWARD" ForcedIndex="0" ForceSeek="0" ForceScan="0" NoExpandHint="0" Storage="RowStore">
                                                            <DefinedValues>
                                                              <DefinedValue>
                                                                <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="UploadedDate" />
                                                              </DefinedValue>
                                                            </DefinedValues>
                                                            <Object Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Index="[TeuResult_PK]" Alias="[R]" TableReferenceId="-1" IndexKind="Clustered" />
                                                            <SeekPredicates>
                                                              <SeekPredicateNew>
                                                                <SeekKeys>
                                                                  <Prefix ScanType="EQ">
                                                                    <RangeColumns>
                                                                      <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="Id" />
                                                                    </RangeColumns>
                                                                    <RangeExpressions>
                                                                      <ScalarOperator ScalarString="[OurLabReporting].[upload].[TeuResult].[Id] as [R].[Id]">
                                                                        <Identifier>
                                                                          <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="Id" />
                                                                        </Identifier>
                                                                      </ScalarOperator>
                                                                    </RangeExpressions>
                                                                  </Prefix>
                                                                </SeekKeys>
                                                              </SeekPredicateNew>
                                                            </SeekPredicates>
                                                          </IndexScan>
                                                        </RelOp>
                                                      </NestedLoops>
                                                    </RelOp>
                                                    <RelOp NodeId="20" PhysicalOp="Filter" LogicalOp="Filter" EstimateRows="1" EstimateIO="0" EstimateCPU="4.8e-007" AvgRowSize="9" EstimatedTotalSubtreeCost="0.00328368" Parallel="0" EstimateRebinds="0" EstimateRewinds="0" EstimatedExecutionMode="Row">
                                                      <OutputList />
                                                      <Filter StartupExpression="0">
                                                        <RelOp NodeId="21" PhysicalOp="Top" LogicalOp="Top" EstimateRows="1" EstimateIO="0" EstimateCPU="1e-007" AvgRowSize="23" EstimatedTotalSubtreeCost="0.0032832" Parallel="0" EstimateRebinds="0" EstimateRewinds="0" EstimatedExecutionMode="Row">
                                                          <OutputList>
                                                            <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[innerR]" Column="Id" />
                                                          </OutputList>
                                                          <Top RowCount="0" IsPercent="0" WithTies="0">
                                                            <TopExpression>
                                                              <ScalarOperator ScalarString="(1)">
                                                                <Const ConstValue="(1)" />
                                                              </ScalarOperator>
                                                            </TopExpression>
                                                            <RelOp NodeId="22" PhysicalOp="Index Seek" LogicalOp="Index Seek" EstimateRows="1" EstimateIO="0.003125" EstimateCPU="0.0001581" AvgRowSize="23" EstimatedTotalSubtreeCost="0.0032831" TableCardinality="4.1884e+007" Parallel="0" EstimateRebinds="0" EstimateRewinds="0" EstimatedExecutionMode="Row">
                                                              <OutputList>
                                                                <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[innerR]" Column="Id" />
                                                              </OutputList>
                                                              <IndexScan Ordered="1" ScanDirection="FORWARD" ForcedIndex="0" ForceSeek="0" ForceScan="0" NoExpandHint="0" Storage="RowStore">
                                                                <DefinedValues>
                                                                  <DefinedValue>
                                                                    <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[innerR]" Column="Id" />
                                                                  </DefinedValue>
                                                                </DefinedValues>
                                                                <Object Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Index="[TeuResult_AgentLog]" Alias="[innerR]" IndexKind="NonClustered" />
                                                                <SeekPredicates>
                                                                  <SeekPredicateNew>
                                                                    <SeekKeys>
                                                                      <Prefix ScanType="EQ">
                                                                        <RangeColumns>
                                                                          <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[innerR]" Column="TeuResultLogId" />
                                                                          <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[innerR]" Column="TeuId" />
                                                                        </RangeColumns>
                                                                        <RangeExpressions>
                                                                          <ScalarOperator ScalarString="NULL">
                                                                            <Const ConstValue="NULL" />
                                                                          </ScalarOperator>
                                                                          <ScalarOperator ScalarString="[OurLabReporting].[upload].[TeuResult].[TeuId] as [R].[TeuId]">
                                                                            <Identifier>
                                                                              <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="TeuId" />
                                                                            </Identifier>
                                                                          </ScalarOperator>
                                                                        </RangeExpressions>
                                                                      </Prefix>
                                                                    </SeekKeys>
                                                                  </SeekPredicateNew>
                                                                </SeekPredicates>
                                                              </IndexScan>
                                                            </RelOp>
                                                          </Top>
                                                        </RelOp>
                                                        <Predicate>
                                                          <ScalarOperator ScalarString="[OurLabReporting].[upload].[TeuResult].[Id] as [R].[Id]=[OurLabReporting].[upload].[TeuResult].[Id] as [innerR].[Id]">
                                                            <Compare CompareOp="EQ">
                                                              <ScalarOperator>
                                                                <Identifier>
                                                                  <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="Id" />
                                                                </Identifier>
                                                              </ScalarOperator>
                                                              <ScalarOperator>
                                                                <Identifier>
                                                                  <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[innerR]" Column="Id" />
                                                                </Identifier>
                                                              </ScalarOperator>
                                                            </Compare>
                                                          </ScalarOperator>
                                                        </Predicate>
                                                      </Filter>
                                                    </RelOp>
                                                  </NestedLoops>
                                                </RelOp>
                                              </TopSort>
                                            </RelOp>
                                            <RelOp NodeId="25" PhysicalOp="Clustered Index Seek" LogicalOp="Clustered Index Seek" EstimateRows="1" EstimateIO="0.003125" EstimateCPU="0.0001581" AvgRowSize="27" EstimatedTotalSubtreeCost="0.0032831" TableCardinality="4.1884e+007" Parallel="0" EstimateRebinds="0" EstimateRewinds="0" EstimatedExecutionMode="Row">
                                              <OutputList>
                                                <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="Id" />
                                                <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="TeuResultLogId" />
                                              </OutputList>
                                              <IndexScan Ordered="1" ScanDirection="FORWARD" ForcedIndex="0" ForceSeek="0" ForceScan="0" NoExpandHint="0" Storage="RowStore">
                                                <DefinedValues>
                                                  <DefinedValue>
                                                    <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="Id" />
                                                  </DefinedValue>
                                                  <DefinedValue>
                                                    <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="TeuResultLogId" />
                                                  </DefinedValue>
                                                </DefinedValues>
                                                <Object Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Index="[TeuResult_PK]" Alias="[R]" TableReferenceId="1" IndexKind="Clustered" />
                                                <SeekPredicates>
                                                  <SeekPredicateNew>
                                                    <SeekKeys>
                                                      <Prefix ScanType="EQ">
                                                        <RangeColumns>
                                                          <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="Id" />
                                                        </RangeColumns>
                                                        <RangeExpressions>
                                                          <ScalarOperator ScalarString="[OurLabReporting].[upload].[TeuResult].[Id] as [R].[Id]">
                                                            <Identifier>
                                                              <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="Id" />
                                                            </Identifier>
                                                          </ScalarOperator>
                                                        </RangeExpressions>
                                                      </Prefix>
                                                    </SeekKeys>
                                                  </SeekPredicateNew>
                                                </SeekPredicates>
                                              </IndexScan>
                                            </RelOp>
                                          </NestedLoops>
                                        </RelOp>
                                      </ComputeScalar>
                                    </RelOp>
                                  </ComputeScalar>
                                </RelOp>
                              </Spool>
                            </RelOp>
                          </ComputeScalar>
                        </RelOp>
                      </Update>
                    </RelOp>
                    <RelOp NodeId="36" PhysicalOp="Clustered Index Seek" LogicalOp="Clustered Index Seek" EstimateRows="1" EstimateIO="0.003125" EstimateCPU="0.0001581" AvgRowSize="9" EstimatedTotalSubtreeCost="0.0032831" TableCardinality="1.35982e+006" Parallel="0" EstimateRebinds="0" EstimateRewinds="0" EstimatedExecutionMode="Row">
                      <OutputList />
                      <IndexScan Ordered="1" ScanDirection="FORWARD" ForcedIndex="1" ForceSeek="0" ForceScan="0" NoExpandHint="0" Storage="RowStore">
                        <DefinedValues />
                        <Object Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResultLog]" Index="[TeuResultLog_PK]" IndexKind="Clustered" />
                        <SeekPredicates>
                          <SeekPredicateNew>
                            <SeekKeys>
                              <Prefix ScanType="EQ">
                                <RangeColumns>
                                  <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResultLog]" Column="Id" />
                                </RangeColumns>
                                <RangeExpressions>
                                  <ScalarOperator ScalarString="[OurLabReporting].[upload].[TeuResult].[TeuResultLogId] as [R].[TeuResultLogId]">
                                    <Identifier>
                                      <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResult]" Alias="[R]" Column="TeuResultLogId" />
                                    </Identifier>
                                  </ScalarOperator>
                                </RangeExpressions>
                              </Prefix>
                            </SeekKeys>
                          </SeekPredicateNew>
                        </SeekPredicates>
                      </IndexScan>
                    </RelOp>
                  </NestedLoops>
                </RelOp>
                <Predicate>
                  <ScalarOperator ScalarString="CASE WHEN NOT [Pass1017] AND [Expr1016] IS NULL THEN (0) ELSE NULL END">
                    <IF>
                      <Condition>
                        <ScalarOperator>
                          <Logical Operation="AND">
                            <ScalarOperator>
                              <Logical Operation="NOT">
                                <ScalarOperator>
                                  <Identifier>
                                    <ColumnReference Column="Pass1017" />
                                  </Identifier>
                                </ScalarOperator>
                              </Logical>
                            </ScalarOperator>
                            <ScalarOperator>
                              <Logical Operation="IS NULL">
                                <ScalarOperator>
                                  <Identifier>
                                    <ColumnReference Column="Expr1016" />
                                  </Identifier>
                                </ScalarOperator>
                              </Logical>
                            </ScalarOperator>
                          </Logical>
                        </ScalarOperator>
                      </Condition>
                      <Then>
                        <ScalarOperator>
                          <Const ConstValue="(0)" />
                        </ScalarOperator>
                      </Then>
                      <Else>
                        <ScalarOperator>
                          <Const ConstValue="NULL" />
                        </ScalarOperator>
                      </Else>
                    </IF>
                  </ScalarOperator>
                </Predicate>
              </Assert>
            </RelOp>
          </QueryPlan>
        </StmtSimple>
        <StmtSimple StatementText=" EXEC upload.TeuResult_ProcessPath @logId = @logId&#xD;&#xA;&#xD;&#xA;&#x9;    /*&#xD;&#xA;&#x9;    ** Move our results across&#xD;&#xA;&#x9;    */&#xD;&#xA;&#x9;   " StatementId="15" StatementCompId="18" StatementType="EXECUTE PROC" RetrievedFromCache="true" />
        <StmtSimple StatementText=" EXEC upload.TeuResult_ProcessXferResults @logId = @logId&#xD;&#xA;&#xD;&#xA;&#x9;    /*&#xD;&#xA;&#x9;    ** Recalculate our summarized pass\fail counts&#xD;&#xA;&#x9;    */&#xD;&#xA;&#x9;   " StatementId="16" StatementCompId="19" StatementType="EXECUTE PROC" RetrievedFromCache="true" />
        <StmtSimple StatementText=" EXEC upload.TeuResult_ProcessRecalcPassFail @logId = @logId&#xD;&#xA;&#xD;&#xA;       " StatementId="17" StatementCompId="20" StatementType="EXECUTE PROC" RetrievedFromCache="true" />
        <StmtSimple StatementText=" SET @hasProcessingError = 0&#xD;&#xA;   " StatementId="18" StatementCompId="21" StatementType="ASSIGN" RetrievedFromCache="true" />
        <StmtSimple StatementText=" END TRY&#xD;&#xA;   " StatementId="19" StatementCompId="22" StatementType="END TRY" RetrievedFromCache="true" />
        <StmtSimple StatementText=" BEGIN CATCH     &#xD;&#xA;       " StatementId="20" StatementCompId="23" StatementType="BEGIN CATCH" RetrievedFromCache="true" />
        <StmtSimple StatementText=" DECLARE @errorLine int&#xD;&#xA;        DECLARE @errorState int&#xD;&#xA;        DECLARE @errorNumber int&#xD;&#xA;        DECLARE @errorSeverity int&#xD;&#xA;        DECLARE @errorProcedure varchar(128)&#xD;&#xA;&#xD;&#xA;        SELECT &#xD;&#xA;            @errorLine = ERROR_LINE(),&#xD;&#xA;            @errorState = ERROR_STATE(),&#xD;&#xA;            @errorNumber = ERROR_NUMBER(),&#xD;&#xA;            @errorSeverity = ERROR_SEVERITY(),&#xD;&#xA;            @errorProcedure = ISNULL(ERROR_PROCEDURE(), '-');&#xD;&#xA;&#xD;&#xA;        -- Manufacture an error message from exception caught in catch clause.&#xD;&#xA;       " StatementId="21" StatementCompId="24" StatementType="ASSIGN" RetrievedFromCache="true" />
        <StmtSimple StatementText=" SET @errorMessage = &#xD;&#xA;            'Error ' + LTRIM(STR(@errorNumber)) + &#xD;&#xA;            ', Level ' + LTRIM(STR(@errorSeverity)) +  &#xD;&#xA;            ', State ' + LTRIM(STR(@errorState)) +  &#xD;&#xA;            ', Procedure ' + @errorProcedure + &#xD;&#xA;            ', Line ' + LTRIM(STR(@errorLine)) +   &#xD;&#xA;            ', Message: ' + ERROR_MESSAGE();&#xD;&#xA;&#xD;&#xA;        -- Mark the attempt as failed.&#xD;&#xA;       " StatementId="22" StatementCompId="25" StatementType="ASSIGN" RetrievedFromCache="true" />
        <StmtSimple StatementText=" SET @hasProcessingError = 1&#xD;&#xA;&#xD;&#xA;        -- An error (e.g. from XACT_ABORT) that ordinarily ends a transaction outside a TRY block causes a transaction to enter an &#xD;&#xA;        -- uncommittable state when the error occurs inside a TRY block. An uncommittable transaction can only perform read operations &#xD;&#xA;        -- or a ROLLBACK TRANSACTION. Since we do not expect any transaction to be uncommitted in catch clause, we blindly rollback.&#xD;&#xA;       " StatementId="23" StatementCompId="26" StatementType="ASSIGN" RetrievedFromCache="true" />
        <StmtCond StatementText=" IF (XACT_STATE()) &lt;&gt; 0 &#xD;&#xA;       " StatementId="24" StatementCompId="27" StatementType="COND" RetrievedFromCache="true">
          <Condition />
          <Then>
            <Statements>
              <StmtSimple StatementText=" BEGIN&#xD;&#xA;            ROLLBACK TRANSACTION;&#xD;&#xA;       " StatementId="25" StatementCompId="28" StatementType="ROLLBACK TRANSACTION" RetrievedFromCache="true" />
            </Statements>
          </Then>
        </StmtCond>
        <StmtSimple StatementText=" END;&#xD;&#xA;    END CATC" StatementId="26" StatementCompId="30" StatementType="END CATCH" RetrievedFromCache="true" />
        <StmtSimple StatementText="H;&#xD;&#xA;&#xD;&#xA;&#x9;/*&#xD;&#xA;&#x9;** Flag log as complete.&#xD;&#xA;&#x9;*/&#xD;&#xA;&#x9;UPDATE upload.TeuResultLog&#xD;&#xA;&#x9;SET &#xD;&#xA;        Processed = &#xD;&#xA;        (&#xD;&#xA;            CASE @hasProcessingError&#xD;&#xA;                WHEN 0 THEN 1&#xD;&#xA;                ELSE 0&#xD;&#xA;            END&#xD;&#xA;        ),&#xD;&#xA;        ProcessingDuration = DATEDIFF(millisecond, @stopwatchBeginTime, SYSDATETIME()),&#xD;&#xA;        HasError = @hasProcessingError, &#xD;&#xA;        ErrorMessage = CONVERT(varchar(4096), @errorMessage)&#xD;&#xA;&#x9;WHERE Id = @logId  &#xD;&#xA;&#xD;&#xA;    -- Re-throw errors to ensure they are captured in SQL agent history. &#xD;&#xA;   " StatementId="27" StatementCompId="32" StatementType="UPDATE" RetrievedFromCache="true" StatementSubTreeCost="0.0232853" StatementEstRows="1" StatementOptmLevel="TRIVIAL" QueryHash="0xE4AE3EA7EA73F2EA" QueryPlanHash="0x1089E04CCE87DE4C">
          <StatementSetOptions QUOTED_IDENTIFIER="false" ARITHABORT="true" CONCAT_NULL_YIELDS_NULL="true" ANSI_NULLS="true" ANSI_PADDING="true" ANSI_WARNINGS="true" NUMERIC_ROUNDABORT="false" />
          <QueryPlan NonParallelPlanReason="MaxDOPSetToOne" CachedPlanSize="32" CompileTime="4" CompileCPU="4" CompileMemory="520">
            <MemoryGrantInfo SerialRequiredMemory="0" SerialDesiredMemory="0" />
            <OptimizerHardwareDependentProperties EstimatedAvailableMemoryGrant="193313" EstimatedPagesCached="773254" EstimatedAvailableDegreeOfParallelism="1" />
            <RelOp NodeId="1" PhysicalOp="Clustered Index Update" LogicalOp="Update" EstimateRows="1" EstimateIO="0.02" EstimateCPU="2e-006" AvgRowSize="9" EstimatedTotalSubtreeCost="0.0232853" Parallel="0" EstimateRebinds="0" EstimateRewinds="0" EstimatedExecutionMode="Row">
              <OutputList />
              <Update DMLRequestSort="0">
                <Object Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResultLog]" Index="[TeuResultLog_PK]" IndexKind="Clustered" />
                <Object Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResultLog]" Index="[TeuResultLog_Processed]" IndexKind="NonClustered" />
                <SetPredicate>
                  <ScalarOperator ScalarString="[OurLabReporting].[upload].[TeuResultLog].[Processed] = RaiseIfNullUpdate([Expr1003]),[OurLabReporting].[upload].[TeuResultLog].[ProcessingDuration] = [Expr1004],[OurLabReporting].[upload].[TeuResultLog].[HasError] = RaiseIfNullUpdate([Expr1005]),[OurLabReporting].[upload].[TeuResultLog].[ErrorMessage] = [@errorMessage]">
                    <ScalarExpressionList>
                      <ScalarOperator>
                        <MultipleAssign>
                          <Assign>
                            <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResultLog]" Column="Processed" />
                            <ScalarOperator>
                              <Intrinsic FunctionName="RaiseIfNullUpdate">
                                <ScalarOperator>
                                  <Identifier>
                                    <ColumnReference Column="Expr1003" />
                                  </Identifier>
                                </ScalarOperator>
                              </Intrinsic>
                            </ScalarOperator>
                          </Assign>
                          <Assign>
                            <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResultLog]" Column="ProcessingDuration" />
                            <ScalarOperator>
                              <Identifier>
                                <ColumnReference Column="Expr1004" />
                              </Identifier>
                            </ScalarOperator>
                          </Assign>
                          <Assign>
                            <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResultLog]" Column="HasError" />
                            <ScalarOperator>
                              <Intrinsic FunctionName="RaiseIfNullUpdate">
                                <ScalarOperator>
                                  <Identifier>
                                    <ColumnReference Column="Expr1005" />
                                  </Identifier>
                                </ScalarOperator>
                              </Intrinsic>
                            </ScalarOperator>
                          </Assign>
                          <Assign>
                            <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResultLog]" Column="ErrorMessage" />
                            <ScalarOperator>
                              <Identifier>
                                <ColumnReference Column="@errorMessage" />
                              </Identifier>
                            </ScalarOperator>
                          </Assign>
                        </MultipleAssign>
                      </ScalarOperator>
                    </ScalarExpressionList>
                  </ScalarOperator>
                </SetPredicate>
                <RelOp NodeId="2" PhysicalOp="Compute Scalar" LogicalOp="Compute Scalar" EstimateRows="1" EstimateIO="0" EstimateCPU="1e-007" AvgRowSize="20" EstimatedTotalSubtreeCost="0.0032833" Parallel="0" EstimateRebinds="0" EstimateRewinds="0" EstimatedExecutionMode="Row">
                  <OutputList>
                    <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResultLog]" Column="Id" />
                    <ColumnReference Column="Expr1003" />
                    <ColumnReference Column="Expr1004" />
                    <ColumnReference Column="Expr1005" />
                    <ColumnReference Column="Expr1026" />
                  </OutputList>
                  <ComputeScalar>
                    <DefinedValues>
                      <DefinedValue>
                        <ColumnReference Column="Expr1026" />
                        <ScalarOperator ScalarString="[Expr1026]">
                          <Identifier>
                            <ColumnReference Column="Expr1026" />
                          </Identifier>
                        </ScalarOperator>
                      </DefinedValue>
                    </DefinedValues>
                    <RelOp NodeId="3" PhysicalOp="Compute Scalar" LogicalOp="Compute Scalar" EstimateRows="1" EstimateIO="0" EstimateCPU="1e-007" AvgRowSize="20" EstimatedTotalSubtreeCost="0.0032833" Parallel="0" EstimateRebinds="0" EstimateRewinds="0" EstimatedExecutionMode="Row">
                      <OutputList>
                        <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResultLog]" Column="Id" />
                        <ColumnReference Column="Expr1003" />
                        <ColumnReference Column="Expr1004" />
                        <ColumnReference Column="Expr1005" />
                        <ColumnReference Column="Expr1026" />
                      </OutputList>
                      <ComputeScalar>
                        <DefinedValues>
                          <DefinedValue>
                            <ColumnReference Column="Expr1003" />
                            <ScalarOperator ScalarString="CONVERT_IMPLICIT(bit,CASE WHEN [@hasProcessingError]=(0) THEN (1) ELSE (0) END,0)">
                              <Convert DataType="bit" Style="0" Implicit="1">
                                <ScalarOperator>
                                  <IF>
                                    <Condition>
                                      <ScalarOperator>
                                        <Compare CompareOp="EQ">
                                          <ScalarOperator>
                                            <Identifier>
                                              <ColumnReference Column="@hasProcessingError" />
                                            </Identifier>
                                          </ScalarOperator>
                                          <ScalarOperator>
                                            <Const ConstValue="(0)" />
                                          </ScalarOperator>
                                        </Compare>
                                      </ScalarOperator>
                                    </Condition>
                                    <Then>
                                      <ScalarOperator>
                                        <Const ConstValue="(1)" />
                                      </ScalarOperator>
                                    </Then>
                                    <Else>
                                      <ScalarOperator>
                                        <Const ConstValue="(0)" />
                                      </ScalarOperator>
                                    </Else>
                                  </IF>
                                </ScalarOperator>
                              </Convert>
                            </ScalarOperator>
                          </DefinedValue>
                          <DefinedValue>
                            <ColumnReference Column="Expr1004" />
                            <ScalarOperator ScalarString="datediff(millisecond,CONVERT_IMPLICIT(datetimeoffset(7),[@stopwatchBeginTime],0),CONVERT_IMPLICIT(datetimeoffset(7),sysdatetime(),0))">
                              <Identifier>
                                <ColumnReference Column="ConstExpr1013">
                                  <ScalarOperator>
                                    <Intrinsic FunctionName="datediff">
                                      <ScalarOperator>
                                        <Const ConstValue="(9)" />
                                      </ScalarOperator>
                                      <ScalarOperator>
                                        <Convert DataType="datetimeoffset" Style="0" Implicit="1">
                                          <ScalarOperator>
                                            <Identifier>
                                              <ColumnReference Column="@stopwatchBeginTime" />
                                            </Identifier>
                                          </ScalarOperator>
                                        </Convert>
                                      </ScalarOperator>
                                      <ScalarOperator>
                                        <Convert DataType="datetimeoffset" Style="0" Implicit="1">
                                          <ScalarOperator>
                                            <Intrinsic FunctionName="sysdatetime" />
                                          </ScalarOperator>
                                        </Convert>
                                      </ScalarOperator>
                                    </Intrinsic>
                                  </ScalarOperator>
                                </ColumnReference>
                              </Identifier>
                            </ScalarOperator>
                          </DefinedValue>
                          <DefinedValue>
                            <ColumnReference Column="Expr1005" />
                            <ScalarOperator ScalarString="CONVERT_IMPLICIT(bit,[@hasProcessingError],0)">
                              <Convert DataType="bit" Style="0" Implicit="1">
                                <ScalarOperator>
                                  <Identifier>
                                    <ColumnReference Column="@hasProcessingError" />
                                  </Identifier>
                                </ScalarOperator>
                              </Convert>
                            </ScalarOperator>
                          </DefinedValue>
                          <DefinedValue>
                            <ColumnReference Column="Expr1026" />
                            <ScalarOperator ScalarString="CASE WHEN CASE WHEN [OurLabReporting].[upload].[TeuResultLog].[Processed] = CONVERT_IMPLICIT(bit,CASE WHEN [@hasProcessingError]=(0) THEN (1) ELSE (0) END,0) THEN (1) ELSE (0) END THEN (0) ELSE (1) END">
                              <IF>
                                <Condition>
                                  <ScalarOperator>
                                    <IF>
                                      <Condition>
                                        <ScalarOperator>
                                          <Compare CompareOp="BINARY IS">
                                            <ScalarOperator>
                                              <Identifier>
                                                <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResultLog]" Column="Processed" />
                                              </Identifier>
                                            </ScalarOperator>
                                            <ScalarOperator>
                                              <Convert DataType="bit" Style="0" Implicit="1">
                                                <ScalarOperator>
                                                  <IF>
                                                    <Condition>
                                                      <ScalarOperator>
                                                        <Compare CompareOp="EQ">
                                                          <ScalarOperator>
                                                            <Identifier>
                                                              <ColumnReference Column="@hasProcessingError" />
                                                            </Identifier>
                                                          </ScalarOperator>
                                                          <ScalarOperator>
                                                            <Const ConstValue="(0)" />
                                                          </ScalarOperator>
                                                        </Compare>
                                                      </ScalarOperator>
                                                    </Condition>
                                                    <Then>
                                                      <ScalarOperator>
                                                        <Const ConstValue="(1)" />
                                                      </ScalarOperator>
                                                    </Then>
                                                    <Else>
                                                      <ScalarOperator>
                                                        <Const ConstValue="(0)" />
                                                      </ScalarOperator>
                                                    </Else>
                                                  </IF>
                                                </ScalarOperator>
                                              </Convert>
                                            </ScalarOperator>
                                          </Compare>
                                        </ScalarOperator>
                                      </Condition>
                                      <Then>
                                        <ScalarOperator>
                                          <Const ConstValue="(1)" />
                                        </ScalarOperator>
                                      </Then>
                                      <Else>
                                        <ScalarOperator>
                                          <Const ConstValue="(0)" />
                                        </ScalarOperator>
                                      </Else>
                                    </IF>
                                  </ScalarOperator>
                                </Condition>
                                <Then>
                                  <ScalarOperator>
                                    <Const ConstValue="(0)" />
                                  </ScalarOperator>
                                </Then>
                                <Else>
                                  <ScalarOperator>
                                    <Const ConstValue="(1)" />
                                  </ScalarOperator>
                                </Else>
                              </IF>
                            </ScalarOperator>
                          </DefinedValue>
                        </DefinedValues>
                        <RelOp NodeId="4" PhysicalOp="Top" LogicalOp="Top" EstimateRows="1" EstimateIO="0" EstimateCPU="1e-007" AvgRowSize="12" EstimatedTotalSubtreeCost="0.0032832" Parallel="0" EstimateRebinds="0" EstimateRewinds="0" EstimatedExecutionMode="Row">
                          <OutputList>
                            <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResultLog]" Column="Id" />
                            <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResultLog]" Column="Processed" />
                          </OutputList>
                          <Top RowCount="0" IsPercent="0" WithTies="0">
                            <TopExpression>
                              <ScalarOperator ScalarString="(1)">
                                <Const ConstValue="(1)" />
                              </ScalarOperator>
                            </TopExpression>
                            <RelOp NodeId="5" PhysicalOp="Clustered Index Seek" LogicalOp="Clustered Index Seek" EstimateRows="1" EstimateIO="0.003125" EstimateCPU="0.0001581" AvgRowSize="12" EstimatedTotalSubtreeCost="0.0032831" TableCardinality="1.35982e+006" Parallel="0" EstimateRebinds="0" EstimateRewinds="0" EstimatedExecutionMode="Row">
                              <OutputList>
                                <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResultLog]" Column="Id" />
                                <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResultLog]" Column="Processed" />
                              </OutputList>
                              <IndexScan Ordered="1" ScanDirection="FORWARD" ForcedIndex="0" ForceSeek="0" ForceScan="0" NoExpandHint="0" Storage="RowStore">
                                <DefinedValues>
                                  <DefinedValue>
                                    <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResultLog]" Column="Id" />
                                  </DefinedValue>
                                  <DefinedValue>
                                    <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResultLog]" Column="Processed" />
                                  </DefinedValue>
                                </DefinedValues>
                                <Object Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResultLog]" Index="[TeuResultLog_PK]" IndexKind="Clustered" />
                                <SeekPredicates>
                                  <SeekPredicateNew>
                                    <SeekKeys>
                                      <Prefix ScanType="EQ">
                                        <RangeColumns>
                                          <ColumnReference Database="[OurLabReporting]" Schema="[upload]" Table="[TeuResultLog]" Column="Id" />
                                        </RangeColumns>
                                        <RangeExpressions>
                                          <ScalarOperator ScalarString="[@logId]">
                                            <Identifier>
                                              <ColumnReference Column="@logId" />
                                            </Identifier>
                                          </ScalarOperator>
                                        </RangeExpressions>
                                      </Prefix>
                                    </SeekKeys>
                                  </SeekPredicateNew>
                                </SeekPredicates>
                              </IndexScan>
                            </RelOp>
                          </Top>
                        </RelOp>
                      </ComputeScalar>
                    </RelOp>
                  </ComputeScalar>
                </RelOp>
              </Update>
            </RelOp>
          </QueryPlan>
        </StmtSimple>
        <StmtCond StatementText=" IF @hasProcessingError = 1 &#xD;&#xA;   " StatementId="28" StatementCompId="33" StatementType="COND" RetrievedFromCache="true">
          <Condition />
          <Then>
            <Statements>
              <StmtCond StatementText=" BEGIN&#xD;&#xA;        IF @errorMessage IS NULL" StatementId="29" StatementCompId="34" StatementType="COND" RetrievedFromCache="true">
                <Condition />
                <Then>
                  <Statements>
                    <StmtSimple StatementText=" SET @errorMessage = 'Unknown error.'&#xD;&#xA;        -- RAISERROR does not allow all severity/state to be raised, use lower, known values. &#xD;&#xA;       " StatementId="30" StatementCompId="35" StatementType="ASSIGN" RetrievedFromCache="true" />
                  </Statements>
                </Then>
              </StmtCond>
              <StmtSimple StatementText=" RAISERROR(@errorMessage, 15, 1);&#xD;&#xA;   " StatementId="31" StatementCompId="37" StatementType="RAISERROR" RetrievedFromCache="true" />
            </Statements>
          </Then>
        </StmtCond>
        <StmtSimple StatementText=" END&#xD;&#xA;&#xD;&#xA;RETURN @hasProcessingError" StatementId="32" StatementCompId="39" StatementType="RETURN" RetrievedFromCache="true" />
      </Statements>
    </Batch>
  </BatchSequence>
</ShowPlanXML>